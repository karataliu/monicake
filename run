#!/usr/bin/env perl

use strict;
use warnings;
use feature qw(say);

my $command = shift;

sub info
{
    my $msg = shift;
    say "[MONICAKE] $msg";
}

sub run()
{
    my $cmd = shift;
    info "Executing:$cmd";
    #system($cmd);
}

sub installPackage
{
    my $packageLine = join(" ", @_);
    my $cmd         = "DEBIAN_FRONTEND=noninteractive apt-get -y install $packageLine";
    my $ret;

    info "Begin install following packages:$packageLine";

    $ret = &run($cmd);
    if (!$ret){
        info("Install succeed.");
    }else{
        info("Install failed.");
    }
}

my $php_conf = << 'EOM';
php_value max_execution_time 300
php_value memory_limit 128M
php_value post_max_size 16M
php_value upload_max_filesize 2M
php_value max_input_time 300
php_value date.timezone Asia/Shanghai
EOM

my $php_zab = << 'EOM';
<?php
// Zabbix GUI configuration file
global $DB;

$DB['TYPE']     = 'MYSQL';
$DB['SERVER']   = 'localhost';
$DB['PORT']     = '0';
$DB['DATABASE'] = 'zabbix';
$DB['USER']     = 'root';
$DB['PASSWORD'] = 'k';

// SCHEMA is relevant only for IBM_DB2 database
$DB['SCHEMA'] = '';

$ZBX_SERVER      = 'localhost';
$ZBX_SERVER_PORT = '10051';
$ZBX_SERVER_NAME = '';

$IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG;
?>
EOM

if ($command eq "agent"){
    info("Begin install Zabbix Agent.");
    installPackage("zabbix-agent");
}elsif ($command eq "server"){
    info("Begin install Zabbix Server.");
    installPackage("zabbix-server-mysql zabbix-frontend-php php5-mysql");
    run("echo 'Alias /z /usr/share/zabbix' > /etc/apache2/sites-available/zabbix.conf");
    run("a2ensite zabbix");
    run("echo '$php_conf' > /etc/apache2/conf-available/php-zabbix.conf");
    run("a2enconf php-zabbix");
    run("service apache2 restart");
    run("mysqladmin -u root password p1");
} else {
    say "$0 <agent|server>";
}



